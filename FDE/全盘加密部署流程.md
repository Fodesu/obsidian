# 前提
- 操作系统 :  Ubuntu 24.04
- 加密安装完成
- 用户的密码设置
- 硬件支持TPM
	- 安装 tpm2-tools 后执行 `systemd-cryptenroll --tpm2-device=list` 检测当前的设备是否有 tpm 支持

## 准备
安装 deacut 和 tpm2-tools
```bash
apt update -y
apt install drauct tpm2-tools tpm2-tss-engine-tools
# 检查 tpm2 模块是否存在
systemd-cryptenroll --tpm2-device=list

# output 类似以下说明存在 
# PATH        DEVICE      DRIVER
# /dev/tpmrm0 MSFT0101:00 tpm_crb

```


## 检测加密安装是否正确
```bash
# 查看加密的磁盘设备名称
lsblk

# 查看 加密设备的 LUKS 密钥槽
systemd-cryptenroll /dev/device-name
# 如果加密安装正确会显示以下结构 SLOT 0 为密码， SLOT 为 recovery-key
# recovery-key 在 /var/log/installer/recovery-key.txt
# SLOT TYPE
#   0 password
#   1 password
```


## 配置crypttab

crypttab 是 Linux 加密磁盘配置表，位于 /etc/crypttab。

它是一个配置文件，定义：

哪些加密设备需要在系统启动时自动解锁
如何解锁这些设备（密码、密钥文件、TPM等）
解密后映射成什么设备名

```bash
# 将配置修改成类似
dm_crypt-0 UUID=xxxxx none luks,tpm2-device=auto,discard,no-read-workqueue,no-write-workqueue
h```

## 配置 dracut
为了让 initramfs 可以访问 tpm 模块， 需要打包 tpm 模块
创建 /etc/dracut.conf.d/tpm2.conf
```bash
hostonly="yes"
add_dracutmodules+=" tpm2-tss "
```

```bash
# 制作新的 initramfs 
sudo dracut -f
```

## 新建 LUKS 策略
此步骤确保在 dracut 制作新的 initramfs 之后执行， 因为 pcr 8 策略会对比 initramfs 的 hash 值, 确保创建的 pcrs hash 保存的是最新的 initramfs 的 hash
```bash
# 输入安装时的密码
systemd-cryptenroll --tpm2-device=auto --tpm2-pcrs="7+8:sha256" /dev/device-name
```


## 测试
重启测试
```bash
sudo reboot
```


## 恢复手段
```bash
# 当自动解锁失败时
# 通过 dracut 紧急 shell 通过 输入密码解谜
cryptsetup open /dev/device-name cryroot

# 成功后 reboot/exit
exit

# 查看 dmsg 错误

```
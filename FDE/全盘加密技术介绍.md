[ubuntu文档](https://documentation.ubuntu.com/security/security-features/storage/encryption-full-disk/)

# 加密技术

## LUKS
### 什么是 LUKS(**Linux Unified Key Setup**) ?
LUKS 是Linux 磁盘加密标准
LUKS 实现了一种与平台无关的磁盘标准格式，供各种工具使用。这有助于不同程序和操作系统之间的兼容性和互操作性，并确保它们都能以安全且有文档记录的方式实现密码管理
### LVM on LUKS
- **结构：** 磁盘 → **LUKS 加密层** → **LVM 物理卷 (PV)** → LVM 卷组 (VG) → LVM 逻辑卷 (LV) → 文件系统。
    
- **流程：** 整个物理设备或分区先被 LUKS 加密。解密后，得到一个加密的块设备，然后将这个块设备用作 LVM 的物理卷。

- **优点:** 
	- 单一密码
	- LVM 灵活性
		- 在解密之后，LVM 的所有功能（如创建、删除、**调整逻辑卷大小**、快照）都可以灵活使用，因为 LVM 是在解密后的设备上操作的。
		- 
- **缺点:**
	- **LVM** 元数据未加密信息泄露：** 在系统断电或锁定时，**未加密的 LUKS 头部**是可见的。更重要的是，**LVM 的结构信息**（如逻辑卷的名称、大小、数量等）**在未解锁时是可见的**。这可能会向攻击者泄露一些关于系统布局的敏感信息。
	- **单一解密：** 无法为不同的逻辑卷设置不同的解密密码，或者在系统运行时单独锁定/解锁某个逻辑卷。

### LUKS on LVM
- **结构：** 磁盘 → **LVM 物理卷 (PV)** → LVM 卷组 (VG) → **LVM 逻辑卷 (LV)** → **LUKS 加密层** → 文件系统。
    
- **流程：** 先使用 LVM 创建逻辑卷，然后将**每个逻辑卷**分别用 LUKS 进行加密。
    
- **优点：**
    
    - **LVM 元数据加密：** 只有 LVM 的物理卷和卷组信 息是可见的。**LVM 逻辑卷的名称和大小**在被 LUKS 加密后**不会**被泄露，因为每个逻辑卷都是一个独立的 LUKS 容器。
        
    - **独立加密/灵活的解密：** 可以为**每个逻辑卷**设置**不同的密码或密钥**，也可以在系统运行时**单独锁定/解锁**某个逻辑卷。
        
- **缺点：**
    
    - **管理复杂性：** 每次启动可能需要输入**多个密码**来解锁不同的逻辑卷（除非使用密钥文件）。管理多个 LUKS 容器比管理一个容器复杂。
        
    - **LVM 灵活性受限：** 一旦在逻辑卷上创建了 LUKS 加密层，**逻辑卷的调整大小（特别是缩小）会变得更加困难和危险**，因为你需要先调整 LUKS 容器内部的文件系统，然后调整 LUKS 容器本身，最后才能调整下层的 LVM 逻辑卷。

**大多数用户和发行版安装程序**倾向于使用 **LVM on LUKS**，因为它在保障全盘加密安全性的同时，提供了 LVM 的全部灵活性，并且只需要输入一个密码。
## TPM(**Trusted Platform Module**)
TPM 是安全加密处理器， 它实现了**ISO/IEC 11889** 标准。常见用途包括验证[启动过程](https://en.wikipedia.org/wiki/Boot_process "Boot process")是否由可信的硬件和软件组合启动，以及存储磁盘加密密钥。
TPM 支持 是将上述 LUKS 中的密码替换成安全芯片中的密钥

### TPM 的 Ubuntu安装自动支持
- Ubuntu desktop/core 支持
- Ubuntu server 不支持， 但可以手动设置

### 基于TPM 磁盘自动解密的理念
安全且无密码的磁盘解密的理念是，TPM2 可以存储一个额外的 LUKS 密钥，只有当 TPM 处于预定的、已知良好状态时，系统才能检索该密钥。这种状态记录在所谓的平台配置寄存器（PCR）中，标准合规的 TPM 中有 24 个。它们的预期用途在 [Linux TPM PCR 注册表](https://uapi-group.org/specifications/specs/linux_tpm_pcr_registry/)中有描述，同时也在 [`systemd-cryptenroll（1）`](https://www.freedesktop.org/software/systemd/man/latest/systemd-cryptenroll.html) 页面中以表格形式简洁总结。

PCR 存储着将在启动时根据 bootloader hash, 固件 , 启动内核, 初始化镜像 等信息的  hash 表， 通过所有从启动到 Linux userspace 的组件建立信任表，我们确保更改任何其中一个组件都会影响一个或者多个PCR, 这些 PCR 用于被 TPM 检测当前的环境是否是预期的良好状态， 只有这样TPM才会释放密钥 

### TPM 在系统启动时自动解谜磁盘流程

1. 系统启动
2. UEFI/固件测量
3. PCR 更新
4. systemd-cryptsetup
5. 请求 TPM 解谜
6. TPM 检查 PCR
7. 若匹配则释放密钥
8. LUKS 解谜

### TPM 配合密码
#### TPM 自动解锁配合恢复密码
当因为TPM解锁失败(BIOS 更新固件 导致 PCR 变化， TPM 芯片丢失) 时回退到密码恢复
这是合理的安全冗余设计，防止硬件变化导致系统被永久锁定
问题：
- 恢复密码可能比TPM弱

#### TPM 回退密码攻击
[原文](https://oddlama.org/blog/bypassing-disk-encryption-with-tpm2-unlock/)
攻击者利用当TPM 解锁失败时回退到要求用户输入密码

##### 攻击步骤
1. 攻击者制作自己的加密分区替换原加密分区
2. 触发回退机制
	1. TPM尝试解锁原分区 → 失败（分区已改变）
	2. 回退到密码提示
	3. 攻击者输入自己设定的密码
	4. 成功解锁假的LUKS分区
3. 欺骗 initrd 继续启动

##### 为什么可以欺骗 initrd？
攻击者可以获取原分区到UUID
所有 initrd 用来验证的信息都是公开的
- `/boot` 分区未加密
- initrd 镜像未加密
- 内核未加密

##### 如何保护防止这种攻击？
使用 Secure Boot 保护 initramfs
## LUKS + 密码 对比 LUKS + TPM 

| 安全维度          | LUKS + 密码 | LUKS + TPM | 胜者  |
| ------------- | --------- | ---------- | --- |
| **防离线暴力破解**   | ⭐⭐⭐⭐      | ⭐⭐⭐⭐⭐      | TPM |
| **防内存窃取**     | ⭐⭐        | ⭐⭐⭐⭐⭐      | TPM |
| **防键盘记录**     | ⭐         | ⭐⭐⭐⭐⭐      | TPM |
| **防引导阶段恶意软件** | ⭐⭐        | ⭐⭐⭐⭐       | TPM |
| **防物理篡改**     | ⭐⭐⭐       | ⭐⭐⭐⭐⭐      | TPM |
| **恢复灵活性**     | ⭐⭐⭐⭐⭐     | ⭐⭐⭐        | 密码  |
| **硬件依赖**      | 无         | 必需         | 密码  |
| **设置复杂度**     | 简单        | 中等         | 密码  |

## 避免 Live CD/USB 攻击
1. BIOS/UEFI 设置禁止所有外部启动设备
2. BIOS/UEFI 密码
3. Secure Boot

## Secure Boot
保护从固件加载到操作系统内核加载的整个“信任链”建立过程


## 恢复与应急方案

## 多层恢复机制
第一层: TPM 自动解锁(正常情况)
第二层: 带外管理 (IPMI/redfish) ？
第三层: 恢复密钥 (TPM故障 fallback)
第四层: 备份恢复 (灾难恢复)


### 什么是 IPMI
IPMI 是一种开放的、独立于主系统（CPU、BIOS、OS）的硬件管理标准和接口，允许管理员远程监控、诊断和管理服务器硬件，无论主系统是否运行，实现电源控制、温度/风扇监控、事件日志记录、固件更新等功能，提高服务器可用性并降低管理成本。
IPMI 提供了远程 ssh 管理机器
通过IPMI 我们可以远程恢复 自动解锁 故障和监控设备


### Redfish
redfish 是新一代 IPMI 

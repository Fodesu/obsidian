# 全盘加密方案
# 核心安全原则

| 固件安全 | BIOS密码      |
| ---- | ----------- |
| 引导安全 | Secure Boot |
| 加密安全 | LUKS+TPM    |

# 加密方案选择
## **LUKS2 + TPM2 + Secure Boot** (如果设备支持TPM2.0)
自动解锁 ： TPM2.0 + PCR 策略
引导保护: Secure Boot + 签名验证
恢复机制: 恢复密钥 + 网络解锁


## 为什么需要自动解锁
用户手动输入的密码是解锁加密 LUKS 分区的传统且广泛使用的方法。 但是它有一些缺点
- 它需要手动干预，因此不适用于需要远程重启的设置（例如大型服务器集群）。
- 普通人的大脑能够记住相对简单的密码，这些密码比现代块密码（128/256 位）使用的密钥弱得多。

# Ubuntu24.04 实施步骤
## 安装时配置
选择选项 Create encrypted volume, 和 `recovery key`
`recovery key` 路径在 `/var/log/installer/recovery-key.txt`


## TPM tool 安装
```bash
apt install tpm2-tools -y
```

## Dracut 安装
使用 dracut 代替 initramfs-tools
```bash
apt install dracut -y
```
ubuntu 默认的update-initramfs 使用的 initramfs-tools 有 [bug](https://bugs.launchpad.net/ubuntu/+source/cryptsetup/+bug/1980018) 在使用 `update-initramfs -u `时 会爆出错误
使用 dracut 代替 initramfs-tools 可以避免这个 bug

## TPM 配置

```bash
#!/bin/bash -e

# /dev/下的  crypto root 设备名
crypt_root_dev=vda3
# 删除加密设备中当前配置的 TPM2 槽位
sudo systemd-cryptenroll --wipe-slot=tpm2 /dev/$crypt_root_dev

# 新建 tpm2 槽位，设置自动寻找 tpm2 设备， 设置pcrs, --tpm2-with-pin=yes 设置 pin
sudo systemd-cryptenroll --tpm2-device=auto --tpm2-pcrs="7+8:sha256" /dev/$crypt_root_dev

```

### PCRS  选择

#### PCR值详解表

| PCR       | 测量内容                                                                                                  | 何时变化                                    | 安全性作用       |
| --------- | ----------------------------------------------------------------------------------------------------- | --------------------------------------- | ----------- |
| **PCR 7** | **安全启动状态**  <br>• 安全启动是否启用  <br>• 平台密钥(PK)  <br>• 密钥交换密钥(KEK)  <br>• 已签名数据库(db/dbx)                   | 安全启动设置变更  <br>UEFI固件更新  <br>添加/删除安全启动密钥 | 防止禁用安全启动的攻击 |
| **PCR 8** | **引导加载程序和内核**  <br>• GRUB2/shim (如果使用)  <br>• systemd-stub (如果使用)  <br>• 内核(vmlinuz)  <br>• initramfs | 内核更新  <br>initramfs更新  <br>引导加载器更新      | 防止内核/引导链被篡改 |
| PCR 0-5   | 核心系统固件  <br>BIOS/UEFI代码  <br>选项ROM                                                                    | 固件更新  <br>硬件变更                          | 过于严格，影响恢复   |
| PCR 4     | 引导管理器(传统)  <br>MBR/引导扇区                                                                               | 使用GRUB时测量  <br>引导扇区修改                   | GRUB传统模式使用  |
| PCR 9-16  | 保留给操作系统使用                                                                                             | 系统自定义用途                                 | 可用于应用程序度量   |

|PCR组合|安全性|便利性|适用场景|
|---|---|---|---|
|**7+8 (推荐)**|⭐⭐⭐⭐⭐|⭐⭐⭐⭐|**现代UEFI+安全启动**  <br>• systemd-boot/systemd-stub  <br>• GRUB with shim|
|0-7|⭐⭐⭐⭐⭐|⭐|**最高安全**  <br>• 固件+安全启动+内核  <br>• 军事/金融级安全|
|7 only|⭐⭐|⭐⭐⭐⭐⭐|**仅防禁用安全启动**  <br>• 内核更新频繁  <br>• 不需要内核完整性|
|4+7|⭐⭐⭐⭐|⭐⭐⭐|**传统GRUB引导**  <br>• Legacy BIOS或传统GRUB  <br>• 不使用systemd-stub|


## `/etc/crypttab` 配置

crypttab 是 描述加密块的配置

修改 crypttab 类似下面的配置

```
dm_crypt-0 UUID=xxxxx none luks,tpm2-device=auto,discard,no-read-workqueue,no-write-workqueue
```
dm_crypt-0
 - 作用： 这是映射后的设备名称。
 - 解释： 解锁成功后，加密的物理设备将被映射为一个虚拟的块设备，路径为 /dev/mapper/dm_crypt-0，供系统挂载和使用。
UUID=xxxxx
- 作用： 指定要解锁的物理加密设备。
- 解释： 通过 UUID 唯一标识了 LUKS 加密的分区（例如 /dev/sda2 或 /dev/nvme0n1p2）。这比使用设备名（如 /dev/sda2）更稳定可靠。
none
- 作用： 密钥来源。
- 解释： 此处为 none，表示不使用密码或密钥文件。它依赖于后面的 tpm2-device=auto 选项，意味着将尝试使用 TPM2 芯片作为解锁密钥。
选项列表 (luks, tpm2-device=auto, discard, no-read-workqueue, no-write-workqueue)
这是配置的核心，定义了如何解锁和设备行为：

1. luks： 指定加密格式为 LUKS。
2. tpm2-device=auto： 关键解锁方式。
- 系统将自动检测 TPM2 芯片。
- 如果 TPM2 芯片中存储的密钥与加密设备（由上述 UUID 指定）绑定，且系统状态（PCRs）未发生改变，则会自动静默解锁该设备。这通常用于实现全盘加密系统的自动启动。
3. discard： 启用 TRIM 命令支持。
- 允许加密设备将已删除数据块的“未使用”状态传递给底层固态硬盘（SSD），有助于 SSD 进行垃圾回收和维持性能。这是一个性能/磨损优化选项，但可能对加密安全性有细微影响（会泄露哪些块是空闲的）。
4. no-read-workqueue, no-write-workqueue： 性能优化选项。
- 它们会绕过内核的工作队列机制，让加密/解密操作在原始进程上下文中直接执行。
- 这可以降低 I/O 延迟，尤其对高速存储（如 NVMe SSD）有益，但可能会略微增加 CPU 占用。


## Dracut 制作 initramfs
配置 /etc/dracut.conf.d/tpm2.conf

```conf
hostonly="yes"
add_dracutmodules+=" tpm2-tss "
```

```bash

sudo dracut -f
```

## 重启查看是否配置成功
```
reboot now
```
 如果 boot 阶段黑屏/要求输入 device password 或者 tpm2 pin 说明配置失败了

## Secure Boot 配置
进入 BIOS/UEFI 来启用 Secure Boot 


## 禁止Live CD/USB 等外部启动
进入 BIOS/UEFI 设置禁止外部启动
设置 BIOS/UEFI 密码


## 恢复与应急方案

## 多层恢复机制
第一层: TPM 自动解锁(正常情况)
第二层: 恢复密钥 (TPM故障)
第三层: 带外管理 (IPMI/iDRAC)
第四层: 备份恢复 (灾难恢复)




